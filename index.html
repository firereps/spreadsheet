<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Panel z itemami - Firebase</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0;}
  header { background: #222; color: #fff; padding: 15px; text-align:center;}
  .hidden { display:none; }
  #login-panel, #admin-panel { max-width: 400px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 8px;}
  input, button, textarea { width: 100%; margin: 8px 0; padding: 10px; border-radius:4px; border:1px solid #ccc; font-size: 16px;}
  button { background: #28a745; color: white; font-weight: bold; cursor: pointer; border:none;}
  button:hover { background: #218838;}
  #items-container { max-width: 900px; margin: 30px auto; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;}
  .item { background: #fff; border-radius: 8px; box-shadow: 0 0 6px #aaa; width: 220px; padding: 15px; display:flex; flex-direction: column; }
  .item img { width: 100%; border-radius: 6px; object-fit: cover; height: 140px; }
  .item h3 { margin: 10px 0 5px; cursor: grab;}
  .item p { flex-grow:1; cursor: grab; }
  .btn-group { margin-top: 10px; display: flex; justify-content: space-between; }
  .btn-group button { width: 48%; font-size: 14px; padding: 8px;}
  .buy-btn { background: #28a745; }
  .buy-btn:hover { background: #218838; }
  .edit-btn { background: #007bff; }
  .edit-btn:hover { background: #0069d9; }
  .delete-btn { background: #dc3545; }
  .delete-btn:hover { background: #c82333; }
  #add-item-btn { margin-top: 10px; }
</style>
</head>
<body>

<header><h1>Sprzedaż Przedmiotów - Panel</h1></header>

<div id="login-panel">
  <h2>Logowanie Administratora</h2>
  <input type="text" id="login-username" placeholder="Nazwa użytkownika" autocomplete="username" />
  <input type="password" id="login-password" placeholder="Hasło" autocomplete="current-password" />
  <button id="login-btn">Zaloguj się</button>
</div>

<div id="admin-panel" class="hidden">
  <h2>Panel Administratora</h2>

  <div id="add-item-panel">
    <input type="text" id="item-name" placeholder="Nazwa przedmiotu" />
    <textarea id="item-desc" placeholder="Opis przedmiotu" rows="3"></textarea>
    <input type="text" id="item-link" placeholder="Link do przedmiotu (np. sklep)" />
    <input type="text" id="item-img" placeholder="Link do obrazka (URL)" />
    <button id="add-item-btn">Dodaj przedmiot</button>
  </div>
  <button id="logout-btn" style="margin-top: 15px; background:#dc3545;">Wyloguj się</button>
</div>

<div id="items-container"></div>

<script type="module">
// firebase importy
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref as dbRef, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB7tQvTVeG-WlBcvTByiKW7GfPpD52vDGw",
  authDomain: "spridszit-firerepy.firebaseapp.com",
  databaseURL: "https://spridszit-firerepy-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "spridszit-firerepy",
  storageBucket: "spridszit-firerepy.firebasestorage.app",
  messagingSenderId: "963006920352",
  appId: "1:963006920352:web:58538b879f004c02873bc5"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let isAdmin = false;

// selektory
const loginPanel = document.getElementById('login-panel');
const adminPanel = document.getElementById('admin-panel');
const itemsContainer = document.getElementById('items-container');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const addItemBtn = document.getElementById('add-item-btn');

const loginUsername = document.getElementById('login-username');
const loginPassword = document.getElementById('login-password');

const itemNameInput = document.getElementById('item-name');
const itemDescInput = document.getElementById('item-desc');
const itemLinkInput = document.getElementById('item-link');
const itemImgInput = document.getElementById('item-img');

loginBtn.onclick = () => {
  const user = loginUsername.value.trim();
  const pass = loginPassword.value.trim();

  if(user === 'admin' && pass === 'admin123') {
    isAdmin = true;
    loginPanel.classList.add('hidden');
    adminPanel.classList.remove('hidden');
    loginUsername.value = '';
    loginPassword.value = '';
    zaladujPrzedmioty();
  } else {
    alert('Niepoprawna nazwa użytkownika lub hasło');
  }
};

logoutBtn.onclick = () => {
  isAdmin = false;
  adminPanel.classList.add('hidden');
  loginPanel.classList.remove('hidden');
  itemsContainer.innerHTML = '';
  zaladujPrzedmioty();
};

function zaladujPrzedmioty() {
  itemsContainer.innerHTML = 'Ładuję przedmioty...';

  const itemsRef = dbRef(db, 'items');
  onValue(itemsRef, (snapshot) => {
    itemsContainer.innerHTML = '';
    const data = snapshot.val();
    if(!data) {
      itemsContainer.innerHTML = '<p>Brak przedmiotów do wyświetlenia.</p>';
      return;
    }

    Object.entries(data).forEach(([key, item]) => {
      const itemEl = document.createElement('div');
      itemEl.className = 'item';

      const titleEl = document.createElement('h3');
      titleEl.textContent = item.name;
      if(isAdmin) {
        titleEl.setAttribute('draggable', 'true');
        titleEl.ondragstart = (e) => {
          e.dataTransfer.setData('text/plain', key);
        };
        titleEl.ondragover = (e) => e.preventDefault();
        titleEl.ondrop = (e) => {
          e.preventDefault();
          const draggedKey = e.dataTransfer.getData('text/plain');
          if(draggedKey && draggedKey !== key) {
            const draggedName = data[draggedKey].name;
            const targetName = item.name;
            update(dbRef(db, `items/${draggedKey}`), { name: targetName });
            update(dbRef(db, `items/${key}`), { name: draggedName });
          }
        };
      }
      itemEl.appendChild(titleEl);

      const descEl = document.createElement('p');
      descEl.textContent = item.description;
      if(isAdmin) {
        descEl.setAttribute('draggable', 'true');
        descEl.ondragstart = (e) => {
          e.dataTransfer.setData('desc', key);
        };
        descEl.ondragover = (e) => e.preventDefault();
        descEl.ondrop = (e) => {
          e.preventDefault();
          const draggedKey = e.dataTransfer.getData('desc');
          if(draggedKey && draggedKey !== key) {
            const draggedDesc = data[draggedKey].description;
            const targetDesc = item.description;
            update(dbRef(db, `items/${draggedKey}`), { description: targetDesc });
            update(dbRef(db, `items/${key}`), { description: draggedDesc });
          }
        };
      }
      itemEl.appendChild(descEl);

      const imgEl = document.createElement('img');
      imgEl.src = item.imageUrl || 'https://via.placeholder.com/220x140?text=Brak+obrazka';
      imgEl.alt = item.name;
      itemEl.appendChild(imgEl);

      const btnGroup = document.createElement('div');
      btnGroup.className = 'btn-group';

      if(isAdmin) {
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.textContent = 'Edytuj';
        editBtn.onclick = () => {
          itemNameInput.value = item.name;
          itemDescInput.value = item.description;
          itemLinkInput.value = item.link;
          itemImgInput.value = item.imageUrl || '';
          addItemBtn.textContent = 'Zapisz zmiany';
          addItemBtn.dataset.editingKey = key;
          window.scrollTo({top: 0, behavior: 'smooth'});
        };
        btnGroup.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Usuń';
        deleteBtn.onclick = () => {
          if(confirm(`Na pewno chcesz usunąć przedmiot "${item.name}"?`)) {
            remove(dbRef(db, `items/${key}`));
          }
        };
        btnGroup.appendChild(deleteBtn);

      } else {
        const buyBtn = document.createElement('button');
        buyBtn.className = 'buy-btn';
        buyBtn.textContent = 'Kup';
        buyBtn.onclick = () => {
          if(item.link) window.open(item.link, '_blank');
        };
        btnGroup.appendChild(buyBtn);
      }

      itemEl.appendChild(btnGroup);
      itemsContainer.appendChild(itemEl);
    });
  });
}

addItemBtn.onclick = async () => {
  const nazwa = itemNameInput.value.trim();
  const opis = itemDescInput.value.trim();
  const link = itemLinkInput.value.trim();
  const img = itemImgInput.value.trim();

  if(!nazwa || !opis || !link || !img) {
    alert('Wszystkie pola są wymagane');
    return;
  }

  addItemBtn.disabled = true;
  addItemBtn.textContent = addItemBtn.dataset.editingKey ? 'Zapisuję zmiany...' : 'Dodaję przedmiot...';

  try {
    if(addItemBtn.dataset.editingKey) {
      // edycja
      const key = addItemBtn.dataset.editingKey;
      await update(dbRef(db, `items/${key}`), {
        name: nazwa,
        description: opis,
        link: link,
        imageUrl: img
      });
      delete addItemBtn.dataset.editingKey;
      addItemBtn.textContent = 'Dodaj przedmiot';
    } else {
      // nowy
      const newItemRef = push(dbRef(db, 'items'));
      await set(newItemRef, {
        name: nazwa,
        description: opis,
        link: link,
        imageUrl: img,
        createdAt: Date.now()
      });
      addItemBtn.textContent = 'Dodaj przedmiot';
    }
    itemNameInput.value = '';
    itemDescInput.value = '';
    itemLinkInput.value = '';
    itemImgInput.value = '';
  } catch(e) {
    alert('Coś poszło nie tak, spróbuj ponownie');
    console.error(e);
  } finally {
    addItemBtn.disabled = false;
  }
};

// na start ladujemy przedmioty
zaladujPrzedmioty();

</script>

</body>
</html>
